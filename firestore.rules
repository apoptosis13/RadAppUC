rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---

    // Check if user is signed in
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if the user has the 'admin' role (Checks both UID and Email indexed documents)
    function isAdmin() {
      return isAuthenticated() && (
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'instructor']) ||
        (exists(/databases/$(database)/documents/users/$(request.auth.token.email)) && 
         get(/databases/$(database)/documents/users/$(request.auth.token.email)).data.role in ['admin', 'instructor'])
      );
    }

    // Check if the user is the Super Admin (Hardcoded protection)
    function isSuperAdmin() {
      // Use matches to check case-insensitive safely
      return isAuthenticated() && request.auth.token.email.matches('(?i)^gonzalodiazs@gmail\\.com$');
    }

    // --- Collection Rules ---

    // Users Collection
    // Supports both UID and Email as document IDs
    match /users/{userId} {
      // Authenticated users can read valid profiles (needed for UI)
      allow read: if isAuthenticated();
      
      // Creation: 
      // 1. Only allow if the auth matches the doc ID (Self-registration)
      // 2. Or if the user is the Super Admin (Manual migration/addition)
      allow create: if isAuthenticated() && (request.auth.uid == userId || request.auth.token.email == userId || isSuperAdmin());
      
      // Updates: 
      // 1. User can update their own non-sensitive fields
      // 2. Admins can update any user (approvals, role changes)
      allow update: if isAuthenticated() && (request.auth.uid == userId || request.auth.token.email == userId || isAdmin());
      
      // Deletion: Super Admin can delete anyone. Admins can delete non-admins/non-instructors.
      allow delete: if isSuperAdmin() || (isAdmin() && !(existingData().role in ['admin', 'instructor']));

      // Subcollections (stats, history, etc.)
      // Allow user to read/write their own nested data
      // Subcollections (stats, history, etc.)
      // Allow user to read/write their own nested data
      match /stats/{document=**} {
        allow read, write: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      }
      match /history/{document=**} {
        allow read, write: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      }
    }

    // Helper to get existing data safely
    function existingData() {
      return resource.data;
    }
    
    // Cases Collection (Clinical Cases)
    match /cases/{caseId} {
      // Students can read
      allow read: if isAuthenticated();
      // Only Admins can create/update/delete
      allow write: if isAdmin();
    }
    
    // Anatomy Modules
    match /anatomy_modules/{moduleId} {
      // Students can read
      allow read: if isAuthenticated();
      // Only Admins can create/update/delete
      allow write: if isAdmin();
    }
    
    // Activity Logs (Audit Trail)
    match /activity_logs/{logId} {
      // Users can only create logs where the 'email' field matches their own
      allow create: if isAuthenticated() && request.resource.data.email == request.auth.token.email;
      
      // Only Admins can view logs
      allow read: if isAdmin() || isSuperAdmin();
      
      // No one can modify or delete logs (Immutable)
      allow update, delete: if false;
    }

    // Diagnostics (For Permission Testing)
    match /diagnostics/{docId} {
      // Admins can see results
      allow read: if isAdmin();
      // Any user allows to run the test (create/delete their own test doc)
      allow create: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
  }
}
